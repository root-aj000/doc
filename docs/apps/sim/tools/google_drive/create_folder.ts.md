This TypeScript code defines a "tool configuration" for creating a new folder in Google Drive. Imagine this as a detailed blueprint or recipe that an application (perhaps an AI agent, automation platform, or internal service) can follow to perform this specific action.

---

### **Purpose of this File**

The primary purpose of this file is to *configure* a specific capability: **creating a new folder in a Google Drive account**.

It serves as a declarative specification that tells an overarching system:
1.  **What the tool is**: Its ID, name, description, and version.
2.  **How it gets permission**: It requires Google Drive OAuth authentication.
3.  **What inputs it needs**: Parameters like folder name, and optional parent folder information.
4.  **How to execute the action**: It defines the HTTP request (URL, method, headers, body) to send to the Google Drive API.
5.  **How to interpret the result**: It specifies how to process the API's response, handling both success and error scenarios, and what data to return.
6.  **What output it produces**: It describes the structured data the tool will provide upon successful completion.

In essence, this file provides all the necessary metadata and logic for an application to seamlessly integrate and use the "Create Google Drive Folder" functionality.

---

### **Simplifying Complex Logic**

The core complexity lies in defining the interaction with the Google Drive API:

1.  **Dynamic Request Construction (`request.headers` and `request.body`):** Instead of fixed values, the headers and body of the API request are generated by *functions* that receive the tool's input parameters. This allows the request to change based on what the user/system provides (e.g., using a specific `accessToken` or `fileName`).
2.  **Parent Folder Logic (`request.body`):** The code intelligently decides which parent folder ID to use. It prioritizes a user-selected folder (`folderSelector`) over an internally provided ID (`folderId`), offering flexibility for different input sources.
3.  **Robust Error Handling (`transformResponse`):** The `transformResponse` function doesn't just assume success. It first checks if the API response was `ok` (HTTP status 2xx). If not, it attempts to extract a meaningful error message from the response body, preventing cryptic errors and providing better feedback.
4.  **Structured Output (`transformResponse` and `outputs`):** The tool guarantees a consistent output structure, wrapping the Google Drive API's raw response into a more usable `output.file` object, which is then formally described in the `outputs` section.

---

### **Detailed Line-by-Line Explanation**

Let's go through the code block by block.

```typescript
import type { GoogleDriveToolParams, GoogleDriveUploadResponse } from '@/tools/google_drive/types'
import type { ToolConfig } from '@/tools/types'
```

*   **`import type { ... } from '...'`**: These lines import type definitions. `type` imports ensure that these types are only used for static type checking during development and compilation, and are completely removed from the compiled JavaScript code. This prevents unnecessary runtime dependencies.
    *   **`GoogleDriveToolParams`**: This likely defines the structure of the input parameters expected by Google Drive-related tools (like `accessToken`, `fileName`, etc.).
    *   **`GoogleDriveUploadResponse`**: This probably defines the expected structure of the successful response data after uploading or creating a file/folder in Google Drive.
    *   **`ToolConfig`**: This is a generic type that defines the overall structure of any tool configuration. It takes two generic arguments: `TParams` (the type of the tool's parameters) and `TResponse` (the type of the tool's successful output).

---

```typescript
export const createFolderTool: ToolConfig<GoogleDriveToolParams, GoogleDriveUploadResponse> = {
  // ... tool configuration properties ...
}
```

*   **`export const createFolderTool`**: This declares a constant variable named `createFolderTool` and makes it available for other files to import and use. This constant holds our entire tool configuration object.
*   **`: ToolConfig<GoogleDriveToolParams, GoogleDriveUploadResponse>`**: This is a type annotation. It specifies that `createFolderTool` must conform to the `ToolConfig` interface, with its input parameters matching `GoogleDriveToolParams` and its successful output matching `GoogleDriveUploadResponse`. This provides strong type checking for the entire configuration.

---

```typescript
  id: 'google_drive_create_folder',
  name: 'Create Folder in Google Drive',
  description: 'Create a new folder in Google Drive',
  version: '1.0',
```

*   **`id: 'google_drive_create_folder'`**: A unique identifier for this tool within the system. It's often used programmatically to reference the tool.
*   **`name: 'Create Folder in Google Drive'`**: A human-readable name for the tool, typically displayed in user interfaces.
*   **`description: 'Create a new folder in Google Drive'`**: A brief explanation of what the tool does, useful for users or AI models to understand its function.
*   **`version: '1.0'`**: The version number of this specific tool configuration, helpful for tracking changes and compatibility.

---

```typescript
  oauth: {
    required: true,
    provider: 'google-drive',
    additionalScopes: ['https://www.googleapis.com/auth/drive.file'],
  },
```

*   **`oauth`**: This object defines the OAuth (Open Authorization) requirements for the tool, specifying how it gains permission to access user data.
    *   **`required: true`**: Indicates that user authentication via OAuth is mandatory for this tool to function.
    *   **`provider: 'google-drive'`**: Specifies that the OAuth provider is Google Drive. The application uses this to know which service to authenticate with.
    *   **`additionalScopes: ['https://www.googleapis.com/auth/drive.file']`**: This is an array of "scopes." Scopes are specific permissions requested from the user during the OAuth flow.
        *   `https://www.googleapis.com/auth/drive.file`: This particular scope grants permission to access and manage files that the application *creates or opens* with the user. It's a relatively narrow scope, meaning the tool won't have access to *all* files in the user's Drive, only those it interacts with directly. This is good for security and user privacy.

---

```typescript
  params: {
    accessToken: {
      type: 'string',
      required: true,
      visibility: 'hidden',
      description: 'The access token for the Google Drive API',
    },
    fileName: {
      type: 'string',
      required: true,
      visibility: 'user-or-llm',
      description: 'Name of the folder to create',
    },
    folderSelector: {
      type: 'string',
      required: false,
      visibility: 'user-only',
      description: 'Select the parent folder to create the folder in',
    },
    folderId: {
      type: 'string',
      required: false,
      visibility: 'hidden',
      description: 'ID of the parent folder (internal use)',
    },
  },
```

*   **`params`**: This object defines the input parameters that the tool expects. Each property within `params` describes a single input.
    *   **`accessToken`**:
        *   `type: 'string'`: The parameter is expected to be a string.
        *   `required: true`: This parameter *must* be provided for the tool to work.
        *   `visibility: 'hidden'`: This parameter is typically handled internally by the system (e.g., automatically injected after OAuth) and should not be exposed directly to end-users or even large language models (LLMs).
        *   `description`: Explains its purpose.
    *   **`fileName`**:
        *   `type: 'string'`: Expected to be a string.
        *   `required: true`: Mandatory.
        *   `visibility: 'user-or-llm'`: This parameter can be provided either by a human user or by an AI (Large Language Model) interacting with the tool. This implies it's a key input for the tool's primary action.
        *   `description`: Clearly states it's for the folder's name.
    *   **`folderSelector`**:
        *   `type: 'string'`: Expected to be a string.
        *   `required: false`: This parameter is optional.
        *   `visibility: 'user-only'`: This suggests it's a user-friendly input, perhaps linked to a UI component where a user selects a folder from a list. It's not typically something an LLM would generate directly.
        *   `description`: Describes its role in selecting a parent folder.
    *   **`folderId`**:
        *   `type: 'string'`: Expected to be a string.
        *   `required: false`: Optional.
        *   `visibility: 'hidden'`: Similar to `accessToken`, this is an internal parameter, likely used when a `folderSelector` is not available or when the parent folder ID is known directly by the system rather than being user-selected.
        *   `description`: Clarifies its internal use as a parent folder ID.

---

```typescript
  request: {
    url: 'https://www.googleapis.com/drive/v3/files?supportsAllDrives=true',
    method: 'POST',
    headers: (params) => ({
      Authorization: `Bearer ${params.accessToken}`,
      'Content-Type': 'application/json',
    }),
    body: (params) => {
      const metadata: {
        name: string | undefined
        mimeType: string
        parents?: string[]
      } = {
        name: params.fileName,
        mimeType: 'application/vnd.google-apps.folder',
      }

      // Add parent folder if specified (prefer folderSelector over folderId)
      const parentFolderId = params.folderSelector || params.folderId
      if (parentFolderId) {
        metadata.parents = [parentFolderId]
      }

      return metadata
    },
  },
```

*   **`request`**: This object defines how to construct the HTTP request to the external API (Google Drive in this case).
    *   **`url: 'https://www.googleapis.com/drive/v3/files?supportsAllDrives=true'`**: The target URL for the API request.
        *   `https://www.googleapis.com/drive/v3/files`: This is the Google Drive API endpoint for creating or managing files.
        *   `?supportsAllDrives=true`: This query parameter allows the operation to create folders within shared drives (formerly Team Drives) as well as personal drives.
    *   **`method: 'POST'`**: Specifies the HTTP method to use. `POST` is used for creating new resources.
    *   **`headers: (params) => ({ ... })`**: This is a function that takes the tool's `params` as input and returns an object representing the HTTP headers for the request.
        *   **`Authorization: \`Bearer ${params.accessToken}\``**: This header is crucial for authentication. It sends the `accessToken` (obtained via OAuth) to Google Drive, proving the user's identity and permission. The `Bearer` prefix is a standard convention for token-based authentication.
        *   **`'Content-Type': 'application/json'`**: This header tells the server that the request body is formatted as JSON.
    *   **`body: (params) => { ... }`**: This is a function that takes the tool's `params` as input and returns the request body (the data payload) as a JavaScript object, which will then be stringified to JSON.
        *   **`const metadata: { ... } = { ... }`**: Declares a `metadata` object that will contain the information for the new folder.
            *   **`name: params.fileName`**: Sets the name of the new folder to the value provided in the `fileName` parameter.
            *   **`mimeType: 'application/vnd.google-apps.folder'`**: This is the critical part that tells Google Drive to create a *folder* instead of a regular file. `application/vnd.google-apps.folder` is the specific MIME type for Google Drive folders.
        *   **`parents?: string[]`**: This property is optional (`?`) and, if present, should be an array of strings (folder IDs). It indicates the parent folder(s) where the new folder should be created.
        *   **`const parentFolderId = params.folderSelector || params.folderId`**: This line implements a preference logic. It tries to get the parent folder ID from `params.folderSelector` first (which is user-facing). If `folderSelector` is empty or `null`, it then falls back to `params.folderId` (the internal ID). This means a user's explicit selection takes precedence.
        *   **`if (parentFolderId) { metadata.parents = [parentFolderId] }`**: If a `parentFolderId` was found (either from `folderSelector` or `folderId`), it's added to the `metadata.parents` array. Google Drive expects an array even for a single parent.
        *   **`return metadata`**: The constructed `metadata` object is returned as the request body.

---

```typescript
  transformResponse: async (response: Response) => {
    if (!response.ok) {
      const data = await response.json().catch(() => ({}))
      throw new Error(data.error?.message || 'Failed to create folder in Google Drive')
    }
    const data = await response.json()

    return {
      success: true,
      output: {
        file: {
          id: data.id,
          name: data.name,
          mimeType: data.mimeType,
          webViewLink: data.webViewLink,
          webContentLink: data.webContentLink,
          size: data.size,
          createdTime: data.createdTime,
          modifiedTime: data.modifiedTime,
          parents: data.parents,
        },
      },
    }
  },
```

*   **`transformResponse: async (response: Response) => { ... }`**: This is an asynchronous function responsible for processing the raw `Response` object received from the Google Drive API.
    *   **`if (!response.ok)`**: Checks if the HTTP response status code indicates success (i.e., status code in the 200-299 range). If `response.ok` is `false`, it means an error occurred.
        *   **`const data = await response.json().catch(() => ({}))`**: If there's an error, it attempts to parse the response body as JSON to get more details. The `.catch(() => ({}))` part is a safeguard: if the response body isn't valid JSON (e.g., a network error or a non-JSON error response), it gracefully defaults to an empty object `{}` to prevent further errors.
        *   **`throw new Error(data.error?.message || 'Failed to create folder in Google Drive')`**: Throws a new `Error`. It tries to use the specific error message from the API response (`data.error?.message`). If that's not available (e.g., `data.error` is undefined or `message` is missing), it falls back to a generic error message. This provides clear feedback on failures.
    *   **`const data = await response.json()`**: If the response *was* successful (`response.ok` is true), this line parses the successful JSON response body into a JavaScript object. This `data` object will contain the metadata of the newly created folder from Google Drive.
    *   **`return { success: true, output: { ... } }`**: If the request was successful, this returns a standardized success object.
        *   **`success: true`**: A boolean flag indicating success.
        *   **`output: { file: { ... } }`**: Contains the actual result data, nested under an `output` property, with the main data under `file`.
            *   **`id: data.id`**: The unique ID of the newly created folder in Google Drive.
            *   **`name: data.name`**: The actual name of the created folder.
            *   **`mimeType: data.mimeType`**: The MIME type, confirming it's a folder.
            *   **`webViewLink: data.webViewLink`**: A URL that allows users to view the folder in their web browser (Google Drive interface).
            *   **`webContentLink: data.webContentLink`**: A URL that allows direct download of the folder's content (though for folders this might not be directly applicable or might lead to a zipped download).
            *   **`size: data.size`**: The size of the folder (might be 0 for an empty folder).
            *   **`createdTime: data.createdTime`**: Timestamp of when the folder was created.
            *   **`modifiedTime: data.modifiedTime`**: Timestamp of when the folder was last modified.
            *   **`parents: data.parents`**: An array of IDs of the parent folders.

---

```typescript
  outputs: {
    file: {
      type: 'json',
      description: 'Created folder metadata including ID, name, and parent information',
    },
  },
}
```

*   **`outputs`**: This object formally describes the structure and nature of the data that the tool will produce upon successful execution. This is useful for other parts of the application (e.g., AI models, UI) to understand what to expect.
    *   **`file`**: This property corresponds to the `file` object returned within the `output` by the `transformResponse` function.
        *   **`type: 'json'`**: Indicates that the `file` output is a JSON object.
        *   **`description`**: A human-readable description of what this output contains.

---

This detailed breakdown covers the purpose, logic, and line-by-line explanation of the `createFolderTool` configuration, demonstrating how it orchestrates an interaction with the Google Drive API to create new folders.